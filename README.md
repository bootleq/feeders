This is a [Next.js](https://nextjs.org/) project bootstrapped with [`c3`](https://developers.cloudflare.com/pages/get-started/c3).

## Getting Started

Prepare env file by copy `.env.sample` to `.env.development`.

First, run the development server:

```bash
pnpm dev

```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.


Prepare to preview:

```bash
pnpm lint
pnpm pages:build
pnpm cms:build-local
pnpm preview
```

`cms:build-local` uploads local CMS data to external storage, our built
application fetches pre-build JSON instead of hitting CMS again.


Then prepare to deploy:

```bash
pnpm pages:build:prod
pnpm env:push:prod
pnpm run deploy
```

The `env:push:prod` loads variables in `.env.production` and uploads them as
Pages secrets. This is to avoid exposing them in `wrangler.toml`.


## Database

Currently, local pages dev doesn't support `--remote` D1, so we use local
sqlite db during development.

When everything is ready, run the drizzle migrations on remote D1.

- List tables, can also used to establish local db first time

    pnpm db:tables

- Migrations with drizzle-kit (locally)

    pnpm db:migrate:gen
    pnpm db:migrate:drop
    pnpm db:migrate

- Remove local db + drizzle meta, then reset with migrations (DANGER)

    pnpm db:delete
    pnpm db:delete && pnpm db:tables && pnpm db:migrate:gen && pnpm db:migrate

- Directly execute commands in D1

    pnpm wrangler d1 execute feeders --command 'PRAGMA table_list'
    pnpm wrangler d1 execute feeders --command 'INSERT INTO users (id, email) VALUES ("foo001", "foo@bar.com")'
    PRAGMA table_xinfo(TABLE_NAME)
    PRAGMA defer_foreign_keys = (on|off)
    SELECT name, sql FROM sqlite_master

- Run migrations on remote D1

    pnpm wrangler d1 list
    pnpm wrangler d1 migrations apply feeders --remote


## Authentication

- Currently testing with Google OAuth provider

- Review approved services (you can revoke permission here)
  https://myaccount.google.com/permissions


## Directus CMS

http://localhost:8044/admin

First time setup will create default admin user, see cms-log to get username/password.

```bash
pnpm cms
pnpm cms-log
pnpm cms-stop
pnpm cms-restart
```

### Asset management

- Make a `public` folder for user upload instead of default as file library root.
- Turn off storage asset transform, let's use other service instead.
- Expect storage is defined with Cloudflare R2 backend, see config in docker-compose.yml. Note the secret text files must not contain EOL character.

### HTML sanitize extension

- https://github.com/licitdev/directus-extension-sanitize-html

  Note the extension is not flexible configurable so I use a dirty customized
  version instead. Need to build and install locally for every change. And it
  is not published so far.

### General WYSIWYG field settings:

- Custom Formats:

```json
[
  {
    "title": "等寬字",
    "inline": "span",
    "classes": "font-mono"
  },
  {
    "title": "冗長網址",
    "selector": "a[href]",
    "classes": "feeders-mce-lengthy"
  },
  {
    "title": "圖說",
    "block": "figure",
    "wrapper": true,
    "classes": "feeders-mce-figure"
  },
  {
    "title": "內嵌容器",
    "block": "p",
    "classes": "feeders-mce-iframe"
  },
  {
    "title": "數值表格",
    "block": "table",
    "selector": "table",
    "classes": "feeders-mce-digit"
  }
]
```

- Options Overrides

```json
{
  "fix_list_elements": true,
  "invalid_elements": "img,h1,h2,h3,h4,h5,h6",
  "content_style": "p { padding-block: 0.25rem; } .font-mono { font-family: monospace; }",
  "content_css": "http://localhost:8055/tinymce/article.css",
  "preview_styles": "color font-size font-family font-weight",
  "sandbox_iframes_exclusions": [
    "youtube.com",
    "youtu.be",
    "bootleq.github.io"
  ]
}

{
  "formats": {
    "bold": {
      "inline": "strong"
    },
    "underline": {
      "inline": "span",
      "classes": "underline",
      "exact": true
    },
    "italic": {
      "inline": "span",
      "classes": "italic"
    },
    "strikethrough": {
      "inline": "span",
      "classes": "line-through",
      "exact": true
    }
  },
  "content_css": "http://localhost:8055/tinymce/general.css",
  "preview_styles": "color font-size font-family font-weight"
}
```

### Other memo

Schema export: http://localhost:8044/schema/snapshot?export=yaml

Key can be generated by `openssl rand -base64 36`


## Build

    pnpm build

With Bundle Analyzer

    ANALYZE=true pnpm build


## Admin Tasks

- Inactive user

    pnpm tsx scripts/admin_activate_user.mjs {USER_ID} inactive --remote

- Drop spot, or followup

    pnpm tsx scripts/admin_drop_spot.mjs {ID} dropped --remote
    pnpm tsx scripts/admin_drop_followup.mjs {ID} dropped --remote
